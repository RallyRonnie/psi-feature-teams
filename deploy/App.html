<!DOCTYPE html>
<html>
<head>
    <title>psi-feature-teams</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var myMask=null,app=null,PIModel="PortfolioItem/Feature";Ext.define("CustomApp",{scopeType:"release",extend:"Rally.app.App",componentCls:"app",launch:function(){console.log("launch 2"),this.project=this.getContext().getProject().ObjectID,app=this;var that=this,tbName=getReleaseTimeBox(this);this.rows=[],this.customColumns=[{name:"CreationDate",type:"Date"},{name:"LastUpdateDate",type:"Date"}];var configs=[];configs.push({model:"PreliminaryEstimate",fetch:["Name","ObjectID","Value"],filters:[]}),configs.push({model:"Project",fetch:["Name","ObjectID"],filters:[]}),configs.push({model:"Release",fetch:["Name","ObjectID","Project","ReleaseStartDate","ReleaseDate"],filters:[]}),configs.push({model:"Iteration",fetch:["Name","ObjectID","Project","StartDate","EndDate"],filters:[]}),async.map(configs,this.wsapiQuery,function(err,results){console.log("results",results),that.peRecords=results[0],that.projects=results[1],that.releases=results[2],that.iterations=results[3],that.createReleaseCombo(that.releases)})},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,sorters:config.sorters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})},createReleaseCombo:function(releaseRecords){var releases=_.map(releaseRecords,function(rec){return{name:rec.get("Name"),objectid:rec.get("ObjectID"),releaseDate:new Date(Date.parse(rec.get("ReleaseDate")))}});releases=_.uniq(releases,function(r){return r.name}),releases=_.sortBy(releases,function(rec){return rec.releaseDate}).reverse();var releasesStore=Ext.create("Ext.data.Store",{fields:["name","objectid"],data:releases}),cb=Ext.create("Ext.ux.CheckCombo",{itemId:"comboRelease",fieldLabel:"Release",store:releasesStore,queryMode:"local",displayField:"name",valueField:"name",noData:!0,width:300,listeners:{scope:this,collapse:function(field,eOpts){this.queryFeatures(releases)}}}),cbCompleted=Ext.create("Rally.ui.CheckboxField",{fieldLabel:"Hide Completed",itemId:"cbCompleted",value:!0,listeners:{scope:this,change:function(){this.queryFeatures(releases)}}}),container=Ext.create("Ext.container.Container",{layout:{type:"hbox",align:"stretch",defaultMargins:{top:5,right:20,bottom:0,left:5}}});container.add(cb),container.add(cbCompleted),this.add(container)},queryFeatures:function(releases){var comboRelease=this.down("#comboRelease"),cbCompleted=this.down("#cbCompleted"),that=this;if(this.rows=[],""!==comboRelease.getValue()){var selectedR=[];if(_.each(comboRelease.getValue().split(","),function(rn){var matching_releases=_.filter(releases,function(r){return rn==r.name}),uniq_releases=_.uniq(matching_releases,function(r){return r.name});_.each(uniq_releases,function(release){selectedR.push(release)})}),selectedR.length>0){myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."}),myMask.show();var filter=null,compFilter=null;_.each(selectedR,function(release,i){var f=Ext.create("Rally.data.QueryFilter",{property:"Release.Name",operator:"=",value:release.name});filter=0===i?f:filter.or(f)}),cbCompleted.getValue()===!0&&(filter=filter.and(Ext.create("Rally.data.QueryFilter",{property:"PercentDoneByStoryPlanEstimate",operator:"<",value:1})));var fetch=["ObjectID","FormattedID","Name","LeafStoryCount","AcceptedLeafStoryCount","LeafStoryPlanEstimateTotal","AcceptedLeafStoryPlanEstimateTotal","PercentDoneByStoryCount","Release","Rank"];fetch=fetch.concat(_.pluck(app.customColumns,"name")),console.log("fetch",fetch);var config={model:PIModel,fetch:fetch,filters:[filter],sorters:[{property:"Rank",direction:"ASC"}]};async.map([config],this.wsapiQuery,function(err,results){myMask.hide(),console.log("# of features in chart:",results[0].length),that.createTable(results[0])})}}},addCustomFields:function(fields){_.each(app.customColumns,function(col){fields.push({name:col.name,type:col.type})})},addCustomColumns:function(columns){_.each(app.customColumns,function(col){var c={header:col.name,dataIndex:col.name,width:75,hidden:!0,renderer:app.renderCustomColumn};columns.push(c)})},renderCustomColumn:function(value,meta,rec,row,col){var h=app.columns[col].header,v=rec.raw[h];return-1!=h.indexOf("Date")?Ext.Date.format(v,"m/d/Y"):v},addCustomValues:function(row,feature){_.each(app.customColumns,function(col){row[col.name]=feature.get(col.name)})},addGrid:function(){var that=this,height=500;this.store=Ext.create("Rally.data.custom.Store",{fields:[{name:"ID",type:"string"},{name:"Name",type:"string"},{name:"Release",type:"string"},{name:"PlannedEndDate",type:"date"},{name:"LastIterationDate",type:"date"},{name:"Notes",type:"string"},{name:"Progress"}],data:this.rows}),this.columns=[{header:"ID",dataIndex:"ID",width:50,align:"center",locked:!0,renderer:this.renderLink},{header:"Name",dataIndex:"Name",width:300,locked:!0},{header:"Release",dataIndex:"Release",width:100,locked:!0},{header:"Planned",dataIndex:"PlannedEndDate",width:75,locked:!0,renderer:Ext.util.Format.dateRenderer("m/d/Y")},{header:"Last Iteration",dataIndex:"LastIterationDate",width:75,locked:!0,renderer:Ext.util.Format.dateRenderer("m/d/Y")},{header:"Notes",dataIndex:"Notes",width:100,locked:!0},{header:"Progress",align:"center",renderer:this.renderProgress,width:100,locked:!0}],this.addCustomColumns(this.columns),console.log("cols",this.columns);var g=app.down("#mygrid");g&&g.destroy(),this.grid=Ext.create("Rally.ui.grid.Grid",{id:"mygrid",store:this.store,columnsCfgs:this.columns,viewConfig:{stripeRows:!0},columnLines:!0,listeners:{afterrender:function(grid){},columnshow:function(ct,column,eOpts){console.log("grid",app.grid),app.store.load()}}}),this.add(this.grid)},mapSnapshots:function(features){async.map(features,this.readFeatureSnapshots,function(err,results){})},readFeatureSnapshots:function(feature,callback){var that=this,row={ID:feature.get("FormattedID"),ref:feature.get("_ref"),Name:feature.get("Name"),Notes:feature.get("Notes"),Release:feature.get("Release")._refObjectName,PlannedEndDate:feature.get("PlannedEndDate"),Progress:{progress:p,total:featureTotal,accepted:featureAcceptedTotal},Rank:feature.get("Rank")};app.addCustomValues(row,feature),console.log("row",row),Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,listeners:{scope:this,load:function(store,data,success){var children=_.filter(data,function(d){return 0===d.get("Children").length});row.LastIterationDate=app.lastIterationDate(children);var grouped=_.groupBy(children,function(child){return child.get("Project")});_.each(_.keys(grouped),function(key){var stories=grouped[key],total=_.reduce(stories,function(memo,child){return memo+child.get("PlanEstimate")},0),accepted=_.reduce(stories,function(memo,child){return memo+("Accepted"==child.get("ScheduleState")?child.get("PlanEstimate"):0)},0),p=total>0?100*(accepted/total):0;row.Teams=_.isUndefined(row.Teams)?{}:row.Teams,row.Teams[key]={progress:p,total:total,accepted:accepted}}),app.rows.push(row),callback(null,row)}},fetch:["Project","ScheduleState","PlanEstimate","Children","Iteration"],hydrate:["ScheduleState"],filters:[{property:"_TypeHierarchy",operator:"in",value:["HierarchicalRequirement"]},{property:"_ItemHierarchy",operator:"in",value:[feature.get("ObjectID")]},{property:"__At",operator:"=",value:"current"}]})},createTable:function(features){this.addGrid(),async.map(features,this.readFeature,function(err,results){var tValues=_.compact(_.pluck(results,"Teams")),pOids=[];_.each(tValues,function(t){pOids=pOids.concat(_.keys(t))});var groupedP=_.groupBy(pOids,function(p){return p}),sortedP=_.sortBy(_.keys(groupedP),function(p){return groupedP[p].length}).reverse();_.each(sortedP,function(p){app.columns.push({text:p,header:app.projectName(p),flex:1,width:120,align:"center",renderer:app.renderPercentDone})}),app.grid.reconfigure(null,app.columns),app.store.load()})},projectName:function(pid){var project=_.find(this.projects,function(p){return p.get("ObjectID")==pid});return project?project.get("Name"):null},renderLink:function(value,meta,rec,row,col){return value},renderProgress:function(value,meta,rec,row,col){return app.renderValue(rec.get("Progress"))},renderPercentDone:function(value,meta,rec,row,col){var p=app.columns[col].text;return _.isUndefined(rec.raw.Teams)||_.isUndefined(rec.raw.Teams[p])?"":app.renderValue(rec.raw.Teams[p])},renderValue:function(v){var id=Ext.id();return Ext.defer(function(){Ext.widget("progressbar",{text:""+Math.round(v.progress)+"%"+" ("+v.accepted+"/"+v.total+")",renderTo:id,value:v.progress/100})},50),Ext.String.format('<div id="{0}"></div>',id)},iterationFromId:function(id){var iteration=_.find(app.iterations,function(i){return i.get("ObjectID")===id});return iteration},lastIterationDate:function(stories){var iEndDates=_.map(stories,function(story){var it=story.get("Iteration");if(!_.isUndefined(it)&&!_.isNull(it)){var iteration=app.iterationFromId(it);if(!_.isUndefined(iteration)&&!_.isNull(iteration))return iteration.get("EndDate")}});return iEndDates=_.compact(iEndDates),0===iEndDates.length?null:_.last(_.sortBy(iEndDates))},readFeature:function(feature,callback){var that=this,featureTotal=feature.get("LeafStoryPlanEstimateTotal"),featureAcceptedTotal=feature.get("AcceptedLeafStoryPlanEstimateTotal"),p=featureTotal>0?100*(featureAcceptedTotal/featureTotal):0,row={ID:feature.get("FormattedID"),ref:feature.get("_ref"),Name:feature.get("Name"),Notes:feature.get("Notes"),Release:feature.get("Release")._refObjectName,PlannedEndDate:feature.get("PlannedEndDate"),Progress:{progress:p,total:featureTotal,accepted:featureAcceptedTotal},Rank:feature.get("Rank")};app.addCustomValues(row,feature),console.log("row",row),Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,listeners:{scope:this,load:function(store,data,success){var children=_.filter(data,function(d){return 0===d.get("Children").length});row.LastIterationDate=app.lastIterationDate(children);var grouped=_.groupBy(children,function(child){return child.get("Project")});_.each(_.keys(grouped),function(key){var stories=grouped[key],total=_.reduce(stories,function(memo,child){return memo+child.get("PlanEstimate")},0),accepted=_.reduce(stories,function(memo,child){return memo+("Accepted"==child.get("ScheduleState")?child.get("PlanEstimate"):0)},0),p=total>0?100*(accepted/total):0;row.Teams=_.isUndefined(row.Teams)?{}:row.Teams,row.Teams[key]={progress:p,total:total,accepted:accepted}}),app.rows.push(row),callback(null,row)}},fetch:["Project","ScheduleState","PlanEstimate","Children","Iteration"],hydrate:["ScheduleState"],filters:[{property:"_TypeHierarchy",operator:"in",value:["HierarchicalRequirement"]},{property:"_ItemHierarchy",operator:"in",value:[feature.get("ObjectID")]},{property:"__At",operator:"=",value:"current"}]})}});
                function getReleaseTimeBox(app){var timeboxScope=app.getContext().getTimeboxScope(),tbName=null;if(timeboxScope){var record=timeboxScope.getRecord();tbName=record.get("Name")}else tbName="";return tbName}
                Ext.define("Ext.ux.CheckCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.checkcombo",multiSelect:!0,allSelector:!1,noData:!1,noDataText:"No combo data",addAllSelector:!1,allSelectorHidden:!1,enableKeyEvents:!0,afterExpandCheck:!1,allText:"All",oldValue:"",listeners:{focus:function(cpt){cpt.oldValue=cpt.getValue()},keydown:function(cpt,e,eOpts){var value=cpt.getRawValue(),oldValue=cpt.oldValue;value!==oldValue&&cpt.setValue("")}},createPicker:function(){var me=this,picker,menuCls=Ext.baseCSSPrefix+"menu",opts=Ext.apply({pickerField:me,selModel:{mode:me.multiSelect?"SIMPLE":"SINGLE"},floating:!0,hidden:!0,ownerCt:me.ownerCt,cls:me.el.up("."+menuCls)?menuCls:"",store:me.store,displayField:me.displayField,focusOnToFront:!1,pageSize:me.pageSize,tpl:['<ul><tpl for=".">','<li role="option" class="'+Ext.baseCSSPrefix+'boundlist-item"><span class="x-combo-checker">&nbsp;</span> {'+me.displayField+"}</li>","</tpl></ul>"]},me.listConfig,me.defaultListConfig);return picker=me.picker=Ext.create("Ext.view.BoundList",opts),me.pageSize&&picker.pagingToolbar.on("beforechange",me.onPageChange,me),me.mon(picker,{itemclick:me.onItemClick,refresh:me.onListRefresh,scope:me}),me.mon(picker.getSelectionModel(),{beforeselect:me.onBeforeSelect,beforedeselect:me.onBeforeDeselect,selectionchange:me.onListSelectionChange,scope:me}),me.store.on("load",function(store){0===store.getTotalCount()?(me.allSelectorHidden=!0,me.allSelector!==!1&&me.allSelector.setStyle("display","none"),me.noData!==!1&&me.noData.setStyle("display","block")):(me.allSelectorHidden=!1,me.allSelector!==!1&&me.allSelector.setStyle("display","block"),me.noData!==!1&&me.noData.setStyle("display","none"))}),picker},reset:function(){var me=this;me.setValue("")},setValue:function(value){if(this.value=value,!value)return this.allSelector!==!1&&this.allSelector.removeCls("x-boundlist-selected"),this.callParent(arguments);if("string"==typeof value){var me=this,records=[],vals=value.split(",");return""===value?me.allSelector!==!1&&me.allSelector.removeCls("x-boundlist-selected"):vals.length===me.store.getCount()&&0!==vals.length&&(me.allSelector!==!1?me.allSelector.addCls("x-boundlist-selected"):me.afterExpandCheck=!0),Ext.each(vals,function(val){var record=me.store.getById(parseInt(val,10));record&&records.push(record)}),me.setValue(records)}return this.callParent(arguments)},getValue:function(){return"object"==typeof this.value?this.value.join(","):this.value},getSubmitValue:function(){return this.getValue()},expand:function(){var me=this,bodyEl,picker,collapseIf;!me.rendered||me.isExpanded||me.isDestroyed?(me.fireEvent("expand",me),me.onExpand()):(bodyEl=me.bodyEl,picker=me.getPicker(),collapseIf=me.collapseIf,picker.show(),me.isExpanded=!0,me.alignPicker(),bodyEl.addCls(me.openCls),me.noData===!1&&(me.noData=picker.getEl().down(".x-boundlist-list-ct").insertHtml("beforeBegin",'<div class="x-boundlist-item" role="option">'+me.noDataText+"</div>",!0)),me.addAllSelector===!0&&me.allSelector===!1&&(me.allSelector=picker.getEl().down(".x-boundlist-list-ct").insertHtml("beforeBegin",'<div class="x-boundlist-item" role="option"><span class="x-combo-checker">&nbsp;</span> '+me.allText+"</div>",!0),me.allSelector.on("click",function(e){if(me.allSelector.hasCls("x-boundlist-selected"))me.allSelector.removeCls("x-boundlist-selected"),me.setValue(""),me.fireEvent("select",me,[]);else{var records=[];me.store.each(function(record){records.push(record)}),me.allSelector.addCls("x-boundlist-selected"),me.select(records),me.fireEvent("select",me,records)}}),me.allSelectorHidden===!0?me.allSelector.hide():me.allSelector.show(),me.afterExpandCheck===!0&&(me.allSelector.addCls("x-boundlist-selected"),me.afterExpandCheck=!1)),me.mon(Ext.getDoc(),{mousewheel:collapseIf,mousedown:collapseIf,scope:me}),Ext.EventManager.onWindowResize(me.alignPicker,me),me.fireEvent("expand",me),me.onExpand())},alignPicker:function(){var me=this,picker=me.getPicker();if(me.callParent(),me.addAllSelector===!0){var height=picker.getHeight();height=parseInt(height,10)+20,picker.setHeight(height),picker.getEl().setStyle("height",height+"px")}},onListSelectionChange:function(list,selectedRecords){var me=this,isMulti=me.multiSelect,hasRecords=selectedRecords.length>0;!me.ignoreSelection&&me.isExpanded&&(isMulti||Ext.defer(me.collapse,1,me),(isMulti||hasRecords)&&me.setValue(selectedRecords,!1),hasRecords&&me.fireEvent("select",me,selectedRecords),me.inputEl.focus(),me.addAllSelector===!0&&me.allSelector!==!1&&(selectedRecords.length===me.store.getTotalCount()?me.allSelector.addCls("x-boundlist-selected"):me.allSelector.removeCls("x-boundlist-selected")))}});

            Rally.launchApp('CustomApp', {
                name:"psi-feature-teams",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}
.x-combo-checker { background-position: 50% -2px; margin-left: 1px; background-color: transparent; background-image: url("https://rally1.rallydev.com/apps/2.0rc1/lib/ext/4.1.1a/resources/themes/images/default/grid/unchecked.gif"); background-position: -1px -1px; background-repeat: no-repeat; height: 14px; width: 14px; display: inline-block; } 
.x-boundlist-selected .x-combo-checker { background-image: url("https://rally1.rallydev.com/apps/2.0rc1/lib/ext/4.1.1a/resources/themes/images/default/grid/checked.gif"); }

.x-column-header-inner .x-column-header-text {
    white-space: normal;
}

.x-column-header {
    background-color : #99CCFF;
}

.x-column-header-inner {
    line-height: normal;
    padding-top: 3px !important;
    padding-bottom: 3px !important;
    text-align: center;
    top: 20%;
}

.x-grid-cell-inner {
    overflow: hidden;
    /*padding: 8px 12px;*/
    padding: 6px 2px 2px 2px;
    white-space: nowrap;
    height : 28px;
 }
 
 .tinytext {
    font-size:xx-small;
 }
    </style>
</head>
<body></body>
</html>
